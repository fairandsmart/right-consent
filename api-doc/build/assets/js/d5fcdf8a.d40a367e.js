"use strict";(self.webpackChunkapi_doc=self.webpackChunkapi_doc||[]).push([[9180],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=c(n),h=o,m=p["".concat(l,".").concat(h)]||p[h]||u[h]||r;return n?a.createElement(m,i(i({ref:t},d),{},{components:n})):a.createElement(m,i({ref:t},d))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<r;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},697:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var a=n(7462),o=(n(7294),n(3905));const r={},i="Discover API basics",s={unversionedId:"guides/discover-api-guide",id:"guides/discover-api-guide",title:"Discover API basics",description:"Learn how to use Right Consents API for basic operations:",source:"@site/docs/03-guides/303-discover-api-guide.md",sourceDirName:"03-guides",slug:"/guides/discover-api-guide",permalink:"/docs/guides/discover-api-guide",draft:!1,tags:[],version:"current",sidebarPosition:303,frontMatter:{},sidebar:"docSidebar",previous:{title:"Build a Consent Form",permalink:"/docs/guides/first-consent-form-guide"},next:{title:"Collect from existing form",permalink:"/docs/guides/collect-into-form-guide"}},l={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Overview",id:"overview",level:2},{value:"Authentication",id:"authentication",level:2},{value:"Retreive an Access Token",id:"retreive-an-access-token",level:3},{value:"Generate an API Key",id:"generate-an-api-key",level:3},{value:"Create a Consent Transaction",id:"create-a-consent-transaction",level:2},{value:"Define a Consent Context",id:"define-a-consent-context",level:3},{value:"Create the transaction",id:"create-the-transaction",level:3},{value:"Complete the transaction workflow (HTML mode)",id:"complete-the-transaction-workflow-html-mode",level:2},{value:"Open the consent transaction HTML view",id:"open-the-consent-transaction-html-view",level:3},{value:"Complete the transaction workflow (JSON mode)",id:"complete-the-transaction-workflow-json-mode",level:2},{value:"Get the transaction representation",id:"get-the-transaction-representation",level:3},{value:"Get the consent form and submit values",id:"get-the-consent-form-and-submit-values",level:3},{value:"Get the transaction representation again",id:"get-the-transaction-representation-again",level:3}],d={toc:c};function u(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"discover-api-basics"},"Discover API basics"),(0,o.kt)("p",null,"Learn how to use Right Consents ",(0,o.kt)("strong",{parentName:"p"},"API")," for basic operations:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Understand ",(0,o.kt)("strong",{parentName:"li"},"API basic concepts")," and ressources"),(0,o.kt)("li",{parentName:"ul"},"Create a ",(0,o.kt)("strong",{parentName:"li"},"Consent Transaction")),(0,o.kt)("li",{parentName:"ul"},"Follow the transaction Workflow"),(0,o.kt)("li",{parentName:"ul"},"Use ",(0,o.kt)("strong",{parentName:"li"},"curl")," to make basic API calls for consent collection simple scenario")),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,"To complete this guide you need :"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Roughly 45 minutes"),(0,o.kt)("li",{parentName:"ul"},"Right Consents running with existing models"),(0,o.kt)("li",{parentName:"ul"},"Curl")),(0,o.kt)("h2",{id:"overview"},"Overview"),(0,o.kt)("p",null,"In this guide you will discover the basic concepts and resources of the API. We will use some existing consent elements models to build a transaction and follow the transaction workflow using only API calls."),(0,o.kt)("p",null,"Consent API is more or less like a Online Paiment one, an privileged user create the transaction and forward it to the customer. It is not mandatory to have an authentified customer to fulfill the transaction."),(0,o.kt)("h2",{id:"authentication"},"Authentication"),(0,o.kt)("p",null,"Right Consents define 5 application roles: admin, operator, user, transaction or anonymous. In order to gain a role, calls to the API need to be authentified. Right Consents supports 3 differents authentication schemes: OIDC token, API KEY and embedded token."),(0,o.kt)("p",null,"In this guide we will initiate a transaction as an admin user and let the target subject follow the transaction workflow using embedded tokens. You can either use a OIDC token or an API Key to access API."),(0,o.kt)("h3",{id:"retreive-an-access-token"},"Retreive an Access Token"),(0,o.kt)("p",null,"Use curl to retrieve an Access Token on the Identity Provider (IdP):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'TOKEN="Bearer "+`curl -v -d "client_id=cmclient" -d "username=demo@demo.com" -d "password=demo42" -d "grant_type=password" \\\n        http://localhost:4285/auth/realms/RightConsents/protocol/openid-connect/token | jq -r \'.access_token\'`\n')),(0,o.kt)("p",null,"The access token have a short time validity (5mn) and you'll have to renew it during the guide, just replay that requests when needed."),(0,o.kt)("h3",{id:"generate-an-api-key"},"Generate an API Key"),(0,o.kt)("p",null,"Instead of retrieving an OIDC token from IdP you can generate a Key from the backoffice and use that key directly in a specific request header. The API KEY will never expires and has a specific role that is not admin and you can revoke key if you think it has been corrupted or disclosed."),(0,o.kt)("p",null,"To generate an API KEY, go to the backoffice in the 'Integration' section and the 'Security' subsection and create a new API Key with a scope \"Owner\". The key is only visible at generation, feel free to store it somewhere."),(0,o.kt)("p",null,"You can create a bash variable allowing nexts command to succeed:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'KEY="<PUT THE GENERATED KEY HERE>"\n')),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"}," Be aware that using an API KEY is not as secure as an OIDC token and you ",(0,o.kt)("strong",{parentName:"p"},"only used in HTTPS calls")," to API and never sent to any client side code.")),(0,o.kt)("h2",{id:"create-a-consent-transaction"},"Create a Consent Transaction"),(0,o.kt)("p",null,"The transaction is created by an API Admin or Operator for a particular subject. The transaction creation needs to be performed server side to ensure admin access to the API to not be disclosed in client code and to ensure the best integration scenario capabilities. Once created, the transaction URL needs to be forwarded to the targetted subject in the desired channel (email, web redirection, ...)."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"}," It is possible for a simple user to create a transaction by itself for itself. This allows client side deployment but it implies to have a unified authentication scheme and an Ajax aware client application. This integration will be detailed in other guides.")),(0,o.kt)("h3",{id:"define-a-consent-context"},"Define a Consent Context"),(0,o.kt)("p",null,"In order to create a consent transaction, we have to send a ",(0,o.kt)("strong",{parentName:"p"},"Consent Context")," (subject, layout and configuration) to the API. The context can be designed using the ",(0,o.kt)("strong",{parentName:"p"},"backoffice form designer")," and then adapted to your integration use case ; if you are familiar with its format, you can also generate one from scratch."),(0,o.kt)("p",null,"Here is the simpliest Consent Context possible with a full default configuration."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "subject": "testuser@demo.com",\n  "layoutData": {\n    "type":"layout",\n    "elements":["processing.001"],\n    "orientation":"VERTICAL",\n    "info":"information.001"}\n}\n')),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"}," This context uses elements already created in the ",(0,o.kt)("a",{parentName:"p",href:"first-consent-form-guide"},"First Consent Form Guide"),": information.001, processing.001")),(0,o.kt)("h3",{id:"create-the-transaction"},"Create the transaction"),(0,o.kt)("p",null,"Use the previously retrieved token to create the transaction for the target subject: ",(0,o.kt)("a",{parentName:"p",href:"mailto:testuser@demo.com"},"testuser@demo.com")," by posting the context payload to the consents resource of the API:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'TX=`curl -v --header "Content-Type: application/json" \\\n            --header "CM_KEY: ${KEY}" \\\n            --header "Authorization: ${TOKEN}" \\\n            --request POST \\\n            --data \'{"subject":"testuser@demo.com","layoutData":{"type":"layout","elements":["processing.001"],"orientation":"VERTICAL","info":"information.001"}}\' \\\n            http://localhost:4287/consents` && TX_ID=`echo $TX | jq -r .id` && TX_TOKEN=`echo $TX | jq -r .token`\n')),(0,o.kt)("p",null,"The response will contains the created transaction representation in its body. That representation contains transaction id and transaction token for authorization. The response also contains a 'Location' header with the resource URI already formatted."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"}," If you try to create the same transaction again, the API will detect an existing one with same context and return the existing one instead of creating a new one avoiding orphean and costly resource consumption.")),(0,o.kt)("p",null,"The transaction workflow lifecycle follow 6 states : CREATED, SUBMITTED, COMMITTED, CANCELLED, TIMEOUT, ROLLBACK. After creation, the transaction is now in state CREATED."),(0,o.kt)("p",null,"After creation, it is up to the target subject to interact with API. It supports 2 interaction modes: HTML and JSON."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"In HTML mode, client is supposed to be a browser and everything is done to simplify API interactions with automatic HTML redirections and rendering. This mode is designed to be integrated in existing web site or application with web views by using either IFrame or web redirections."),(0,o.kt)("li",{parentName:"ul"},"In JSON mode, REST principles are applyed and Consent Transaction representation are generated. All the rendering of consent form and transaction representation needs to be implemented manually on the client side.")),(0,o.kt)("p",null,"In the next steps we are going to explore both modes."),(0,o.kt)("h2",{id:"complete-the-transaction-workflow-html-mode"},"Complete the transaction workflow (HTML mode)"),(0,o.kt)("p",null,"In HTML, you have to use either the transaction URI returned in the 'Location' header or build the transaction URI from the returned resource representation. When text/html mimetype is required over API, a simpe call to the transaction root resource will perform needed redirection to the next workflow human task to fullfill."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"TX_URI=http://localhost:4287/consents/${TX_ID}?t=${TX_TOKEN}\n")),(0,o.kt)("h3",{id:"open-the-consent-transaction-html-view"},"Open the consent transaction HTML view"),(0,o.kt)("p",null,"Following the transaction workflow in HTML mode is very easy and only require to open the transaction URI in a browser:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"firefox ${TX_URI} &\n")),(0,o.kt)("p",null,"The API is driven by browser to follow the workflow steps. At the final state and without callback url specified, the subject stay on the transaction representation. Depending on the configuration, that view allows to create a new transaction based on that one to change consent, retrieve the consent receipt or close the window."),(0,o.kt)("h2",{id:"complete-the-transaction-workflow-json-mode"},"Complete the transaction workflow (JSON mode)"),(0,o.kt)("h3",{id:"get-the-transaction-representation"},"Get the transaction representation"),(0,o.kt)("p",null,"To retreive the transaction representation, you just have to perform a GET on the transaction resource."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'TX=`curl -v --header "CM_KEY: ${KEY}" \\\n            --header "Authorization: ${TOKEN}" \\\n            --header "Accept: application/json" \\\n            http://localhost:4287/consents/${TX_ID}`\n')),(0,o.kt)("p",null,"A short version of the transaction just after creation is like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n   "id":"P6f1JU6LjKoUwR5QBEYPgf",\n   "subject":"usertest",\n   "state":"CREATED",\n   "token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJQNmYxSlU2TGpLb1V3UjVRQkVZUGdmIiwiZXhwIjoxNjYwOTMwMzMyfQ.0pGomVcjvGGWshhovRpCKjP6BVOt2K6-W6QXLCVlwsA",\n   "task":"http://localhost:4287/consents/P6f1JU6LjKoUwR5QBEYPgf/submit",\n   "breed":"http://localhost:4287/consents/P6f1JU6LjKoUwR5QBEYPgf/child"\n}\n')),(0,o.kt)("h3",{id:"get-the-consent-form-and-submit-values"},"Get the consent form and submit values"),(0,o.kt)("p",null,"When the transaction is in the state CREATED, the next step is ",(0,o.kt)("em",{parentName:"p"},"submit"),": the submission of consent. Calling the url of the 'task' field will produce the form needed for consent submission and will include a submission link with a fresh token if needed."),(0,o.kt)("p",null,"You can build the next human task URI by getting the task field and the transaction token:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"TX_TASK=`echo $TX | jq -r .task` && TX_TOKEN=`echo $TX | jq -r .token`\n")),(0,o.kt)("p",null,"Now you can call the submit task representation which will return the Consent Form Representation:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'TX_FORM=`curl -v --header "CM_KEY: ${KEY}" \\\n                 --header "Authorization: ${TOKEN}" \\\n                 --header "Accept: application/json" \\\n                 ${TX_TASK}?t=${TX_TOKEN}`\n')),(0,o.kt)("p",null,"The Consent Form contains many information that is used in the HTML rendering. In JSON you have to do all the stuff by yourself for displaying form info and options. You also have to build the consent choices in a format that is suitable for the API, a Map of elements identifiers and choices answer:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'FORM_VALUES=\'{"info":["element/information/\'`echo ${TX_FORM} | jq -r \'.info.entry.key\'`/`echo ${TX_FORM} | jq -r \'.info.serial\'`\'"],"element/processing/\'`echo ${TX_FORM} | jq -r \'.elements[0].entry.key\'`/`echo ${TX_FORM} | jq -r \'.elements[0].serial\'`\'":["accepted"]}\' &&\nSUBMIT_JSON=`curl -v --header "CM_KEY: ${KEY}" \\\n                     --header "Authorization: Bearer ${TOKEN}" \\\n                     --header "Content-Type: application/json" \\\n                     --header "Accept: application/json" \\\n                     --request POST \\\n                     --data ${FORM_VALUES} \\\n                     ${TX_TASK}?t=${TX_TOKEN}`\n')),(0,o.kt)("h3",{id:"get-the-transaction-representation-again"},"Get the transaction representation again"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'TX=`curl -v --header "CM_KEY: ${KEY}" \\\n            --header "Authorization: ${TOKEN}" \\\n            --header "Accept: application/json" \\\n            http://localhost:4287/consents/${TX_ID}` &&\necho ${TX}\n')),(0,o.kt)("p",null,"Notice that now the transaction is in state COMMITTED."),(0,o.kt)("p",null,"Depending on the context configuration, a validation step can also be necessary by sending a code via email or sms to the subject in order to double check identity."))}u.isMDXComponent=!0}}]);